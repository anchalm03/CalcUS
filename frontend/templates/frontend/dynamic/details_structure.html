{% load details_tags %} {% if property.charges != '' %}
<span class="tag is-warning is-large">Partial Charges</span>
<div class="columns box is-desktop" id="charges_structure_details">
    <div>
        <center>
            <div id="charges_viewer_div" style="width: 400px; height: 400px; position: relative"></div>
            <div id="charges_buttons_div">
                <button class="button is-info" onclick="get_charges_struct(); this.remove();">Load partial charges</button>
            </div>
        </center>
    </div>
    <script>
        var charges = {};
        var charges_viewer = $3Dmol.createViewer("charges_viewer_div");
        charges_viewer.setBackgroundColor(0xffffff);
        function get_charges_struct() {
        	$.ajax({
        		method: "POST",
        		url: "/get_structure/",
        		data: {'id': "{{ ensemble.id }}", 'num': {{ structure.number }}, 'transform': 'cube' },

        		headers: {
        			"X-CSRFToken": '{{ csrf_token }}',
        		},
        		success: function(data, textStatus, xhr) {
        			charges_viewer.addModel(data, "xyz");
        			charges_viewer.setStyle({}, {stick:{color: 'black', radius: 0.15}, sphere: {scale: 0.3}});
        			charges_viewer.zoomTo();
        			charges_viewer.render();
        			unpack_charges("{{ property.charges}}");
        		}
        	});
        }
        function unpack_charges(str) {
        	if(str.length == 0) {
        		return
        	}
        	scharges = str.split(';')
        	for(ind_charge = 0; ind_charge < scharges.length; ind_charge++) {
        		arr_charges = [];
        		if(scharges[ind_charge].length == 0) {
        			continue
        		}
        		data = scharges[ind_charge].split(':');
        		name = data[0];
        		all_charges = data[1].split(',');
        		for(ind = 0; ind < all_charges.length; ind++) {
        			arr_charges.push(all_charges[ind]);
        		}
        		charges[name] = arr_charges;
        		$("#charges_buttons_div").append("<button class=\"button\" onclick=\"plot_charges('" + name + "')\">" + name + "</button>");
        	}
        	plot_charges("Mulliken");
        }
        function plot_charges(name) {
        	charges_viewer.removeAllLabels();
        	all_charges = charges[name];
        	for(ind = 0; ind < all_charges.length; ind++) {
        		charges_viewer.addLabel(all_charges[ind], {'fontSize': 14}, {'serial': ind});
        	}

        }
    </script>
</div>
{% endif %} {% if property.has_freq %}
<span class="tag is-warning is-large">Frequencies</span>
<div class="columns box has-text-centered" id="frequency_structure_details">
    <div class="column">
        <center>
            <div id="vib_animation" style="width: 400px; height: 400px; position: relative"></div>
            <div class="slidecontainer">
                <input class="slider is-info" type="range" min="1" max="10" value="4" id="vib_calibration" onchange="animate_vib(-1);">
            </div>
        </center>
    </div>
    <div class="column">
        <center>
            <div id="ir_spectrum" style="width: 500px; height: 400px; margin-bottom: 30px"></div>
            <a class="button is-info" href="/ir_spectrum/{{ property.id }}">Download IR spectrum</a>
        </center>
    </div>
</div>
<div>
    <div class="columns is-multiline is-centered" id="vib_table"></div>
</div>
<script>
    var past_num = -1;
    function animate_vib(num) {
        if (num == -1) {
            num = past_num;
        } else {
            $("#vib_mode_" + past_num).removeClass("has-background-primary");
            $("#vib_mode_" + num).addClass("has-background-primary");
            past_num = num;
        }
        amplitude = document.getElementById("vib_calibration").value / 10;

        $.ajax({
            method: "POST",
            url: "/get_vib_animation/",
            data: {
                id: "{{ property.id }}",
                num: num,
            },

            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
            },
            success: function (data, textStatus, xhr) {
                vib_viewer.stopAnimate();
                vib_viewer.removeAllModels();
                vib_viewer.clear();
                vib_viewer.addModel(data, "xyz");
                vib_viewer.vibrate(10, amplitude, true, null);
                vib_viewer.animate({
                    loop: "backAndForth",
                });
                vib_viewer.setStyle(
                    {},
                    {
                        stick: {
                            color: "black",
                            radius: 0.15,
                        },
                        sphere: {
                            scale: 0.3,
                        },
                    }
                );

                vib_viewer.zoomTo();
                vib_viewer.render();
            },
        });
    }

    var vib_viewer = $3Dmol.createViewer("vib_animation");

    $(document).ready(function () {
        vib_viewer.setBackgroundColor(0xffffff);

        $("#vib_table").load("/vib_table/{{ property.id }}");
        g4 = new Dygraph(document.getElementById("ir_spectrum"), "/ir_spectrum/{{ property.id }}", {
            color: "#202f26",
            strokeWidth: 2,
            xlabel: "Wavelength (cm^-1)",
            ylabel: "Intensity",

            axes: {
                x: {
                    axisLabelFormatter: function (cm) {
                        return -cm;
                    },
                    valueFormatter: function (cm) {
                        return -cm;
                    },
                },
            },
        });
    });
</script>
{% endif %} {% if property.has_uvvis %}
<span class="tag is-warning is-large">UV-Vis</span>
<div class="columns box is-desktop" id="uvvis_structure_details">
    <div class="column">
        <center>
            <div id="uvvis_spectrum" style="width: 80%; height: 400px; margin-bottom: 30px"></div>
            <a class="button is-info" href="/uvvis/{{ property.id }}">Download UV-Vis spectrum</a>
        </center>
        <script>
            $(document).ready(function () {
                g2 = new Dygraph(document.getElementById("uvvis_spectrum"), "/uvvis/{{ property.id }}", {
                    color: "#202f26",
                    strokeWidth: 2,
                    xlabel: "Wavelength (nm)",
                    ylabel: "Absorbance",
                });
            });
        </script>
    </div>
</div>
{% endif %} {% if property.has_nmr %}
<span class="tag is-warning is-large">NMR</span>
<div class="columns box is-desktop" id="enso_structure_details">
    <div class="column">
        <center>
            <div id="nmr_spectrum" style="width: 80%; height: 400px; margin-bottom: 30px"></div>
        </center>
        <script>
            $(document).ready(function () {
                g3 = new Dygraph(document.getElementById("nmr_spectrum"), "/nmr/{{ property.id }}", {
                    color: "#202f26",
                    strokeWidth: 2,
                    xlabel: "Chemical shift (ppm)",
                    ylabel: "Intensity",
                    dateWindow: [-10, 0],
                    axes: {
                        x: {
                            axisLabelFormatter: function (ppm) {
                                return -ppm.toPrecision(2);
                            },
                            valueFormatter: function (ppm) {
                                return -ppm.toPrecision(3);
                            },
                        },
                    },
                });
            });
        </script>
    </div>
</div>
{% endif %} 
{% if property.has_mo %}
<span class="tag is-warning is-large">Molecular Orbitals</span>
<div class="columns box is-desktop" id="mo_structure_details">
    <div class="column"></div>
    <div class="column is-tight">
        <div id="mo_viewer_div" style="width: 400px; height: 400px; position: relative"></div>

        <script>

            var mo_viewer = $3Dmol.createViewer("mo_viewer_div");
            mo_viewer.setBackgroundColor(0xffffff);
            
            function get_cube(orb) {
            	if (orb != -1) {
            		window.mo_selection = orb;
            	}

            	let _orb = mo_selection;

            	$.ajax({
            		method: "POST",
            		url: "/get_mo_cube/",
            		data: {
            			'id': "{{ property.id }}",
            			'orb': _orb,
            		},

            		headers: {
            			"X-CSRFToken": '{{ csrf_token }}',
            		},
            		success: function(data, textStatus, xhr) {

            			let isoval = 10**(-document.getElementById("mo_calibration").value/2);
                        $("#mo_isovalue").html(isoval.toPrecision(2));
            			var voldata = new $3Dmol.VolumeData(data.cube, "cube");
                        mo_viewer.clear();
                        mo_viewer.addModel(data.xyz, "xyz");
                        mo_viewer.setStyle({}, {stick:{color: 'black', radius: 0.15}, sphere: {scale: 0.3}});
                        mo_viewer.addIsosurface(voldata, {isoval: isoval, color: "blue", alpha: 0.90, smoothness: 10});
                        mo_viewer.addIsosurface(voldata, {isoval: -isoval, color: "red", alpha: 0.90, smoothness: 10});
                        mo_viewer.zoomTo();
                        mo_viewer.render();
                    }
            	});
            }

            $(document).ready(function(){
                if(mo_viewer.getModel() == null)
            	    get_cube(0);
            });
        </script>
        <div id="mo_container">
            <button class="button is-info" onclick="get_cube(0);" style="width: 24%">HOMO</button>
            <button class="button is-info" onclick="get_cube(1);" style="width: 24%">LUMO</button>
            <button class="button is-info" onclick="get_cube(2);" style="width: 24%">LUMO+1</button>
            <button class="button is-info" onclick="get_cube(3);" style="width: 24%">LUMO+2</button>

            <div class="slidecontainer">
                <span id="mo_span">Orbital Plotting Isovalue</span>
                <br>
                <input type="range" min="1" max="20" value="8" class="slider" id="mo_calibration" onchange="get_cube(-1);">
                <br>
                Isovalue: <span id="mo_isovalue">0.00010</span>
            </div>
        </div>
    </div>

    <div class="column"></div>
</div>
{% endif %} 

{% if property.has_esp %}
<span class="tag is-warning is-large">Electrostatic Potential Map</span>
<div class="columns box is-desktop" id="esp_structure_details">
    <div class="column"></div>
    <div class="column is-tight">
        <div id="esp_viewer_div" style="width: 400px; height: 400px; position: relative"></div>

        <script>

            var esp_viewer = $3Dmol.createViewer("esp_viewer_div");
            esp_viewer.setBackgroundColor(0xffffff);

            var esp_data = null;
            
            function get_esp_cube() {
            	$.ajax({
            		method: "POST",
            		url: "/get_esp_cube/",
            		data: {
            			'id': "{{ property.id }}",
            		},

            		headers: {
            			"X-CSRFToken": '{{ csrf_token }}',
            		},
            		success: function(data, textStatus, xhr) {
                        esp_data = data;
                        refresh_esp();
                        esp_viewer.zoomTo();
            		}
            	});
            }
            function refresh_esp() {
	            var isoval = 10**(-document.getElementById("esp_calibration").value/2);
	            var max = 0.02*document.getElementById("pot_calibration").value;
                $("#esp_isovalue").html(isoval.toPrecision(2));
                $("#pot_max").html(max.toPrecision(2));
                esp_viewer.clear();
                esp_viewer.addModel(esp_data.xyz, "xyz");
                esp_viewer.setStyle({}, {stick:{color: 'black', radius: 0.15}, sphere: {scale: 0.3}});

                esp_viewer.addVolumetricData(esp_data.density, "cube", {isoval: isoval, opacity: 0.9, voldata: esp_data.esp, volformat: 'cube', volscheme: {gradient: 'roygb', min: max, max: -max} });

                esp_viewer.render();
            }

            $(document).ready(function(){
                if(esp_viewer.getModel() == null)
            	    get_esp_cube();
            });
        </script>
        <div id="esp_container">
            <div class="slidecontainer columns">
                <div class="column">
                    <span id="esp_span">Density Plotting Isovalue</span>
                    <br>
                    <input type="range" min="1" max="15" value="6" class="slider" id="esp_calibration" onchange="refresh_esp();">
                    <br>
                    Isovalue: <span id="esp_isovalue">0.00010</span>
                </div>
                <div class="column">
                    <span id="pot_span">Potential Plotting Span</span>
                    <br>
                    <input type="range" min="1" max="20" value="4" class="slider" id="pot_calibration" onchange="refresh_esp();">
                    <br>
                    Maximal Potential: ±<span id="pot_max">0.00010</span>
                    <br>
                    (<span style="color: blue; font-weight: bold;">Negative</span> to <span style="color: red; font-weight: bold;">positive</span>)
                </div>
            </div>
        </div>
    </div>

    <div class="column"></div>
</div>
{% endif %} 

{% if property.simple_nmr != "" %}
<span class="tag is-warning is-large">NMR</span>
<div class="columns box is-desktop" id="nmr_structure_details">
    <div class="column"></div>
    <div class="column">
        {% get_simple_nmr_shifts_structure property as shifts %}
        <table class="table">
            <thead>
                <tr>
                    <th>Atom number</th>
                    <th>Atom type</th>
                    <th>Raw Shift</th>
                </tr>
            </thead>
            <tbody>
                {% for shift in shifts %}
                <tr>
                    <td>{{ shift.0 }}</td>
                    <td>{{ shift.1 }}</td>
                    <td>{{ shift.2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
